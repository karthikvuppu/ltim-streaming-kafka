{{/*
Modular NetworkPolicy Template
Only applied when: security.features.networkPolicies = true
*/}}
{{- if include "kafka-eks.security.networkPolicies.enabled" . }}
---
# NetworkPolicy for Kafka brokers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.kafka.name }}-kafka
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kafka-eks.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      strimzi.io/cluster: {{ .Values.kafka.name }}
      strimzi.io/kind: Kafka
      strimzi.io/name: {{ .Values.kafka.name }}-kafka
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from clients in allowed namespaces
    {{- if .Values.network.policies.ingress.allowFromNamespaces }}
    {{- range .Values.network.policies.ingress.allowFromNamespaces }}
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ . }}
      ports:
        - protocol: TCP
          port: 9092  # Plain
        - protocol: TCP
          port: 9093  # TLS
        - protocol: TCP
          port: 9094  # External
    {{- end }}
    {{- end }}
    # Allow from Prometheus monitoring
    {{- if .Values.network.policies.ingress.allowMonitoring }}
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.network.policies.ingress.monitoringNamespace }}
      ports:
        - protocol: TCP
          port: 9404  # Metrics
    {{- end }}
    # Allow inter-broker communication
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
      ports:
        - protocol: TCP
          port: 9091  # Replication
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 9093
    # Allow from Zookeeper
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-zookeeper
    # Allow from Entity Operators
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-entity-operator
  egress:
    # Allow to Zookeeper
    - to:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-zookeeper
      ports:
        - protocol: TCP
          port: 2181
    # Allow inter-broker communication
    - to:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-kafka
      ports:
        - protocol: TCP
          port: 9091
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 9093
    # Allow DNS
    {{- if .Values.network.policies.egress.allowDNS }}
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    {{- end }}
    # Allow external egress if needed
    {{- if not .Values.network.policies.egress.denyAll }}
    - to:
        - podSelector: {}
    - to:
        - namespaceSelector: {}
    {{- end }}

---
# NetworkPolicy for Zookeeper
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.kafka.name }}-zookeeper
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kafka-eks.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      strimzi.io/cluster: {{ .Values.kafka.name }}
      strimzi.io/kind: Kafka
      strimzi.io/name: {{ .Values.kafka.name }}-zookeeper
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Kafka brokers
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-kafka
      ports:
        - protocol: TCP
          port: 2181
    # Allow from Entity Operators
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-entity-operator
      ports:
        - protocol: TCP
          port: 2181
    # Allow inter-zookeeper communication
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-zookeeper
      ports:
        - protocol: TCP
          port: 2181
        - protocol: TCP
          port: 2888
        - protocol: TCP
          port: 3888
    # Allow from Prometheus monitoring
    {{- if .Values.network.policies.ingress.allowMonitoring }}
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.network.policies.ingress.monitoringNamespace }}
      ports:
        - protocol: TCP
          port: 9405  # Metrics
    {{- end }}
  egress:
    # Allow inter-zookeeper communication
    - to:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-zookeeper
      ports:
        - protocol: TCP
          port: 2181
        - protocol: TCP
          port: 2888
        - protocol: TCP
          port: 3888
    # Allow DNS
    {{- if .Values.network.policies.egress.allowDNS }}
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    {{- end }}

---
# NetworkPolicy for Entity Operator
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.kafka.name }}-entity-operator
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kafka-eks.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      strimzi.io/cluster: {{ .Values.kafka.name }}
      strimzi.io/kind: Kafka
      strimzi.io/name: {{ .Values.kafka.name }}-entity-operator
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Prometheus monitoring
    {{- if .Values.network.policies.ingress.allowMonitoring }}
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.network.policies.ingress.monitoringNamespace }}
      ports:
        - protocol: TCP
          port: 8080  # Health/metrics
    {{- end }}
  egress:
    # Allow to Kafka
    - to:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-kafka
      ports:
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 9093
    # Allow to Zookeeper
    - to:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: {{ .Values.kafka.name }}
              strimzi.io/kind: Kafka
              strimzi.io/name: {{ .Values.kafka.name }}-zookeeper
      ports:
        - protocol: TCP
          port: 2181
    # Allow to Kubernetes API
    {{- if .Values.network.policies.egress.allowKubernetesAPI }}
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    {{- end }}
    # Allow DNS
    {{- if .Values.network.policies.egress.allowDNS }}
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    {{- end }}
{{- end }}
