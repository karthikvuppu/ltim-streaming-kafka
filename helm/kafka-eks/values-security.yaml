# Security Module - Shared across all environments
# This file contains reusable security configurations
# Environments enable/disable features via feature flags

# ==============================================================================
# AUTHENTICATION CONFIGURATION
# ==============================================================================
authentication:
  # Authentication methods available
  methods:
    # SCRAM-SHA-512 (Username/Password) - DEPRECATED
    scram:
      enabled: false
      mechanism: scram-sha-512

    # Mutual TLS (Certificate-based) - RECOMMENDED
    mtls:
      enabled: true
      description: "Certificate-based authentication using X.509 client certificates"
      certificateValidation:
        enabled: true
        # Certificate requirements
        requireClientCert: true
        # CN/SAN validation
        principalBuilderClass: "io.strimzi.kafka.oauth.server.OAuthKafkaPrincipalBuilder"

    # OAuth/OIDC (Token-based) - RECOMMENDED
    oauth:
      enabled: true
      description: "Token-based authentication using OAuth 2.0 / OIDC"

      # OAuth Server Configuration
      # Example providers: Keycloak, Auth0, Okta, Azure AD, Google, AWS Cognito
      clientId: "kafka-broker"
      clientSecret: ""  # Set via Kubernetes secret or environment variable

      # Token validation endpoints (REQUIRED - Update for your OAuth provider)
      tokenEndpointUri: "https://keycloak.example.com/realms/kafka/protocol/openid-connect/token"
      jwksEndpointUri: "https://keycloak.example.com/realms/kafka/protocol/openid-connect/certs"
      validIssuerUri: "https://keycloak.example.com/realms/kafka"
      introspectionEndpointUri: ""  # Optional: for opaque tokens

      # Token validation settings
      checkIssuer: true
      checkAudience: true
      audience: "kafka"

      # User claim mapping
      usernameClaim: "preferred_username"  # or "sub", "email", "client_id"
      fallbackUsernameClaim: "client_id"
      fallbackUsernamePrefix: "client-account-"

      # Group claim for authorization (optional)
      groupsClaim: "groups"
      groupsClaimDelimiter: ","

      # Token type
      accessTokenIsJwt: true  # false for opaque tokens (requires introspection)

      # SSL/TLS for OAuth endpoints
      sslTruststoreLocation: ""  # Path to truststore for OAuth server certificate
      sslTruststorePassword: ""
      sslTruststoreType: "JKS"
      hostnameVerification: true

      # Connection settings
      connectTimeoutSeconds: 60
      readTimeoutSeconds: 60
      httpRetries: 2

      # Token cache (improves performance)
      enableMetrics: true
      enableECDSA: true

      # Custom claim checks (optional)
      customClaimCheck: ""  # e.g., "@.aud && @.aud == 'kafka'"

  # Default authentication for listeners
  # Options:
  #   - oauth: OAuth 2.0 / OIDC token-based (recommended for microservices)
  #   - tls: Mutual TLS certificate-based (recommended for service-to-service)
  #   - scram-sha-512: Username/password (legacy)
  defaultMethod: oauth  # Change to "tls" for mTLS-only authentication

  # Combined authentication (OAuth + mTLS)
  combined:
    enabled: false  # Set to true to require BOTH OAuth token AND valid certificate
    description: "Require both valid X.509 certificate AND valid OAuth token (defense in depth)"

# ==============================================================================
# AUTHORIZATION CONFIGURATION
# ==============================================================================
authorization:
  # Authorization engine
  engine:
    type: simple  # simple (ACL-based), opa (Open Policy Agent), custom
    enabled: true

  # Super users (bypass all ACLs)
  superUsers:
    - User:CN=my-kafka-entity-topic-operator
    - User:CN=my-kafka-entity-user-operator
    - User:CN=my-kafka-kafka-exporter

  # Default ACL policy
  defaultPolicy:
    denyByDefault: true  # Deny all access unless explicitly allowed

  # Role-based access templates
  roles:
    producer:
      description: "Can produce to topics"
      permissions:
        - resource:
            type: topic
            name: "*"
            patternType: literal
          operations: [Write, Describe, Create]
        - resource:
            type: cluster
          operations: [IdempotentWrite]

    consumer:
      description: "Can consume from topics"
      permissions:
        - resource:
            type: topic
            name: "*"
            patternType: literal
          operations: [Read, Describe]
        - resource:
            type: group
            name: "*"
            patternType: literal
          operations: [Read]

    admin:
      description: "Full administrative access"
      permissions:
        - resource:
            type: topic
            name: "*"
            patternType: literal
          operations: [All]
        - resource:
            type: group
            name: "*"
            patternType: literal
          operations: [All]
        - resource:
            type: cluster
          operations: [All]

# ==============================================================================
# TRANSPORT SECURITY CONFIGURATION
# ==============================================================================
transport:
  # TLS/SSL Configuration
  tls:
    # Enable TLS encryption
    enabled: true

    # Listener-specific TLS settings
    listeners:
      internal:
        enabled: true
        requireAuth: true
      external:
        enabled: true
        requireAuth: true
      interBroker:
        enabled: true
        mutualAuth: true

    # Certificate settings (managed by Strimzi)
    certificates:
      autoRotation: true
      validity:
        clusterCA: 365  # days
        clientCA: 365   # days
        broker: 90      # days

# ==============================================================================
# NETWORK SECURITY CONFIGURATION
# ==============================================================================
network:
  # Kubernetes NetworkPolicies
  policies:
    enabled: true

    # Default ingress policy
    ingress:
      denyAll: true  # Deny all ingress by default
      allowFromNamespaces: []  # Override in environment files
      allowMonitoring: true
      monitoringNamespace: monitoring

    # Default egress policy
    egress:
      denyAll: false  # Allow egress by default (can be restricted in production)
      allowDNS: true
      allowKubernetesAPI: true

# ==============================================================================
# DATA PROTECTION CONFIGURATION
# ==============================================================================
dataProtection:
  # Encryption at rest
  encryptionAtRest:
    enabled: true
    provider: aws-kms  # aws-kms, azure-kv, gcp-kms

    # KMS settings
    kms:
      keyRotation: true
      keySpec: AES_256
      # keyId: ""  # Override in environment for customer-managed keys

  # Storage class configuration
  storageClass:
    name: kafka-encrypted
    provisioner: ebs.csi.aws.com
    type: gp3
    encrypted: true
    parameters:
      iops: 3000
      throughput: 125
    volumeBindingMode: WaitForFirstConsumer
    allowVolumeExpansion: true
    reclaimPolicy: Retain

# ==============================================================================
# AUDIT & COMPLIANCE CONFIGURATION
# ==============================================================================
audit:
  # Audit logging
  logging:
    enabled: true

    # What to audit
    events:
      authentication: true
      authorization: true
      dataAccess: false  # Can impact performance
      adminOperations: true

    # Log retention
    retention:
      maxFileSize: 100MB
      maxFiles: 10

    # Log format
    format:
      type: log4j
      pattern: "[%d] %p %m (%c)%n"

    # Log destination
    destination:
      file: /var/log/kafka/kafka-authorizer.log
      # syslog: ""  # Optional: send to syslog
      # cloudwatch: ""  # Optional: send to CloudWatch

# ==============================================================================
# CONTAINER SECURITY CONFIGURATION
# ==============================================================================
container:
  # Pod Security Standards
  podSecurity:
    enabled: true

    # Security context for Kafka pods
    kafka:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 0
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false

    # Security context for Zookeeper pods
    zookeeper:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 0
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false

# ==============================================================================
# KAFKA-SPECIFIC SECURITY CONFIGURATION
# ==============================================================================
kafka:
  # Broker security settings
  broker:
    # Inter-broker communication
    interBroker:
      protocol: SSL  # PLAINTEXT, SSL, SASL_PLAINTEXT, SASL_SSL
      requireAuth: true

    # SSL/TLS settings
    ssl:
      clientAuth: required  # required, requested, none
      endpointIdentification: HTTPS  # HTTPS, none

    # Topic management
    topics:
      autoCreate: false  # Disable auto-topic creation

  # Zookeeper security
  zookeeper:
    tls:
      enabled: true
    authentication:
      enabled: false  # Zookeeper SASL (optional)

# ==============================================================================
# USER MANAGEMENT CONFIGURATION
# ==============================================================================
users:
  # User provisioning
  provisioning:
    enabled: true
    method: crd  # crd, ldap, external

  # Certificate-based users (for mTLS authentication)
  # Users are identified by their certificate CN or DN
  certificateUsers:
    enabled: true
    # Certificate DN patterns for user identification
    # Format: CN=<username>,OU=<org-unit>,O=<organization>,C=<country>
    dnPattern: "CN={user},OU=applications,O=mycompany,C=US"

  # OAuth-based users (for OAuth authentication)
  # Users are identified by claims in the JWT token
  oauthUsers:
    enabled: true
    # OAuth claims used for user identification
    identityClaim: "preferred_username"  # or "sub", "email"
    # Group membership claim for authorization
    groupsClaim: "groups"

  # Default users (created automatically for initial setup)
  # For OAuth: These represent service accounts with client credentials
  # For mTLS: These represent certificate subjects
  defaultUsers:
    - name: app-producer
      role: producer
      authentication:
        type: oauth  # oauth, tls, scram-sha-512
      oauth:
        clientId: "kafka-producer-app"
        # clientSecret stored in Kubernetes secret
      certificate:
        # For mTLS: Certificate subject/CN
        cn: "kafka-producer-app"
        ou: "applications"
        o: "mycompany"

    - name: app-consumer
      role: consumer
      authentication:
        type: oauth  # oauth, tls, scram-sha-512
      oauth:
        clientId: "kafka-consumer-app"
        # clientSecret stored in Kubernetes secret
      certificate:
        # For mTLS: Certificate subject/CN
        cn: "kafka-consumer-app"
        ou: "applications"
        o: "mycompany"

    - name: admin-user
      role: admin
      authentication:
        type: tls  # Use mTLS for admin access
      certificate:
        cn: "kafka-admin"
        ou: "admins"
        o: "mycompany"
