
kerberos:
  activatedInKafka: false

environment: prod
clusterType: external

domain: iris-streaming.prod.aws.scania.com

subnets:
  private: subnet-0afeb4522b2ed064b, subnet-0fddbd8a941de3b4e, subnet-01f1630c12ec7f40c
  public: subnet-0423b8b8775463560, subnet-0c0586ccf00d51272, subnet-0c34899861e8035bc


schemaRegistry:
  cfkVersion: 2.10.0
  confluentVersion: 7.8.0
  platformVersion: 7.8.0
 # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
  replicas: 3
  internalService: 
    enabled: true
    loadbalancer:
      name: iris-streaming-prod-schemaonprem
  configOverrides:
    log4j:
      'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
      'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
      'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
    server:
      'confluent.schema.registry.anonymous.principal': 'true'
      'authentication.skip.paths': '/*'
  loadbalancer:
    internal: false
    name: iris-streaming-prod-schemaregistry
  dns:
    prefix: schemaregistryaws
  podAntiAffinity:
    - schemaregistry 
  #  - kafka
  #  - zookeeper

restProxy:
  cfkVersion: 2.10.0
  confluentVersion: 7.8.0
  platformVersion: 7.8.0
   # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
  configOverrides:
    log4j:
      'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
      'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
      'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
    server:
      'authentication.method': 'BASIC'
      'authentication.realm': 'KafkaRest'
      'authentication.roles': 'Administrators'
      'confluent.rest.auth.propagate.method': 'JETTY_AUTH'
    jvm:
      '-Djava.security.auth.login.config': '/tmp/restproxy/client.jaas'
  dependencies:
    schemaRegistry:
      authentication:
        type: basic
        basic:
          secretRef: c3-access
  mountedVolumes:
    volumes:
      - name: restproxy-basic-client-jaas
        secret:
          secretName: restproxy-basic-client-jaas
          items:
            - key: client.jaas
              path: client.jaas
      - name: restproxy-basic-users
        secret:
          secretName: restproxy-basic-users
          items:
            - key: basic.txt
              path: basic.txt
    volumeMounts:
      - name: restproxy-basic-client-jaas
        mountPath: /tmp/restproxy
      - name: restproxy-basic-users
        mountPath: /tmp/restproxy/users
  loadbalancer:
    internal: false
    name: iris-streaming-prod-restproxy
    nodeLabels: kafka-arm
  dns:
    prefix: restproxyaws
  podAntiAffinity:
    - kafkarestproxy
  #  - kafka
  #  - zookeeper
  nodeAffinityServiceName: kafka-arm

ksql:
  - enabled: true
    cfkVersion: 2.10.0
    confluentVersion: 7.8.0
    platformVersion: 7.8.0
     # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
    name: ksqldb
    dataVolumeCapacity: 100Gi
    onprem:
      loadbalancer:
        name: iris-streaming-prod-ksqldbonprem
    loadbalancer:
      name: iris-streaming-prod-ksqldb
    dns:
      prefix: ksqldbaws


connect:
  license:
    secretRef: confluent-license
  instances:
    # connect-aws:
    #   cfkVersion: 2.9.2
    #   confluentVersion: 7.5.2
    #   platformVersion: 7.5.2
    #   replicas: 3
    #   image:
    #     application: confluentinc/cp-server-connect:7.5.2
    #   plugins:
    #     - name: kafka-connect-datagen
    #       owner: confluentinc
    #       version: 0.5.3
    #     - name: debezium-connector-mysql
    #       owner: debezium
    #       version: 1.8.1
    #     - name: kafka-connect-hdfs3
    #       owner: confluentinc
    #       version: 1.1.10
    #     - name: kafka-connect-kinesis
    #       owner: confluentinc
    #       version: 1.3.16
    #     - name: kafka-connect-servicenow
    #       owner: confluentinc
    #       version: 2.4.4
    #     - name: connect-transforms
    #       owner: confluentinc
    #       version: 1.4.3
    #     - name: snowflake-kafka-connector
    #       owner: snowflakeinc
    #       version: 1.9.3
    #   loadbalancer:
    #     internal: false
    #     name: iris-streaming-prod-awsconnect
    #     nodeLabels: awsconnect
    #   dns:
    #     prefix: awsconnect
    #   nodeAffinityServiceName: awsconnect
    #   configOverrides:
    #     log4j:
    #       'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
    #       'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
    #       'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","context":"%X{connector.context}","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
    #       'log4j.appender.connectAppender.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","context":"%X{connector.context}","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
    #     server:
    #       'key.converter': 'org.apache.kafka.connect.storage.StringConverter'
    #       'value.converter': 'io.confluent.connect.avro.AvroConverter'
    #   mountedSecrets:
    #     - connect-clients
    connect-onprem:
      cfkVersion: 2.10.0
      confluentVersion: 7.8.0
      platformVersion: 7.8.0
       # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
      replicas: 3
      image:
        application: 541662535189.dkr.ecr.eu-north-1.amazonaws.com/iris-connect:7.8.3.1
        #application: 541662535189.dkr.ecr.eu-north-1.amazonaws.com/iris-connect:7.8.0.3
      plugins:
        - name: kafka-connect-datagen
          owner: confluentinc
          version: 0.5.3
        - name: debezium-connector-mysql
          owner: debezium
          version: 1.8.1
        - name: kafka-connect-hdfs3
          owner: confluentinc
          version: 1.1.10
        - name: kafka-connect-ibmmq-sink
          owner: confluentinc
          version: 2.1.0
        - name: kafka-connect-ibmmq
          owner: confluentinc
          version: 12.1.0
        - name: kafka-connect-oracle-cdc
          owner: confluentinc
          version: 2.9.0
        - name: kafka-connect-jdbc
          owner: confluentinc
          version: 10.7.2
        - name: snowflake-kafka-connector
          owner: snowflakeinc
          version: 1.9.3
        - name: kafka-connect-azure-blob-storage
          owner: confluentinc
          version: 1.6.13
        - name: kafka-connect-servicenow
          owner: confluentinc
          version: 2.4.4
        - name: connect-transforms
          owner: confluentinc
          version: 1.4.3
      loadbalancer:
        name: iris-streaming-prod-onpremconnect
        nodeLabels: kafka-arm
        internal: true
      dns:
        prefix: onpremconnect
      nodeAffinityServiceName: kafka-arm
      configOverrides:
        jvm:
          '-Dcom.ibm.mq.cfg.useIBMCipherMappings': 'false'      
        log4j:
          'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
          'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
          'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","context":"%X{connector.context}","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
          'log4j.appender.connectAppender.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","context":"%X{connector.context}","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
        server:
          'key.converter': 'org.apache.kafka.connect.storage.StringConverter'
          'value.converter': 'io.confluent.connect.avro.AvroConverter'
      mountedSecrets:
        - connect-clients
        - clusterlink-privkey
        - seip-ibmmq-cert

    connect-me:
      cfkVersion: 2.10.0
      confluentVersion: 7.8.0
      platformVersion: 7.8.0
       # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
      replicas: 3
      image:
        application: 541662535189.dkr.ecr.eu-north-1.amazonaws.com/iris-connect:7.8.2.2
        #application: 541662535189.dkr.ecr.eu-north-1.amazonaws.com/iris-connect:7.8.0.2
        #application: 541662535189.dkr.ecr.eu-north-1.amazonaws.com/iris-connect:7.5.2.2
      plugins:
        - name: kafka-connect-datagen
          owner: confluentinc
          version: 0.5.3
        - name: debezium-connector-mysql
          owner: debezium
          version: 1.8.1
        - name: kafka-connect-hdfs3
          owner: confluentinc
          version: 1.1.10
        - name: kafka-connect-jdbc
          owner: confluentinc
          version: 10.3.3
        - name: kafka-connect-oracle-cdc
          owner: confluentinc
          version: 2.2.2
      loadbalancer:
        name: iris-streaming-prod-meconnect
        internal: true
        nodeLabels: kafka-arm
      dns:
        prefix: meconnect
      nodeAffinityServiceName: kafka-arm
      configOverrides:
        log4j:
          'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
          'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
          'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","context":"%X{connector.context}","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
          'log4j.appender.connectAppender.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","context":"%X{connector.context}","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
        server:
          'key.converter': 'org.apache.kafka.connect.storage.StringConverter'
          'value.converter': 'io.confluent.connect.avro.AvroConverter'
      mountedSecrets:
        - connect-clients

controlCenter:
  cfkVersion: 2.10.0
  confluentVersion: 7.8.0
  platformVersion: 7.8.0 
   # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
  dataVolumeCapacity: 300Gi
  configOverrides:
    log4j:
      'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
      'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
      'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
      'log4j.appender.streams.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
    server:
      'confluent.controlcenter.internal.topics.partitions': '4'
      'confluent.controlcenter.disk.skew.warning.min.bytes': '16106127360' # 15Gb
  loadbalancer:
    internal: false
    name: iris-streaming-prod-controlcenter
    nodeLabel: kafka-arm
    certificateArn: arn:aws:acm:eu-north-1:541662535189:certificate/3bce9083-3ec7-4f63-9c12-48abca958621
  dns:
    prefix: controlcenter
  nodeAffinityServiceName: kafka-arm


zookeeper:
  cfkVersion: 2.10.0
  confluentVersion: 7.8.0
  platformVersion: 7.8.0
   # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
  dataVolumeCapacity: 120Gi
  logVolumeCapacity: 90Gi
  podAntiAffinity:
    - zookeeper 
  #  - kafka
  #  - connect
  #  - k2
  #  - srrp
  configOverrides:
    log4j:
      'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
      'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
      'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'

kafka:
  cfkVersion: 2.10.0
  confluentVersion: 7.8.0
  platformVersion: 7.8.0
   # cfkVersion: 2.9.2
 # confluentVersion: 7.5.2
 # platformVersion: 7.5.2
  replicas: 6
  dataVolumeCapacity: 5000Gi
  
  mountedSecrets:
  - secretRef: mtls-mapping

  authorization:
    superUsers:
      - User:serviceirisssp
  rackAssignment:
    nodeLabels:
    - topology\.kubernetes\.io/zone

  dependencies:
    kafkaRest:
      authentication:
        type: bearer
        bearer:
          secretRef: rest-credential
  oneReplicaPerNode: true
  podAntiAffinity:
    - kafka
  #  - zookeeper
  #  - srrp
  #  - k2
  #  - connect

  configOverrides:
    log4j:
      'log4j.logger.io.confluent.security.auth.provider.ldap': 'TRACE'
      'log4j.appender.stdout': 'org.apache.log4j.ConsoleAppender'
      'log4j.appender.stdout.layout': 'org.apache.log4j.EnhancedPatternLayout'
      'log4j.appender.stdout.layout.ConversionPattern': '{"timestamp":"%d{ISO8601}","level":"%p","thread":"%t","class":"%C","message":"%m%throwable{full}"}%n'
    server:
      'confluent.balancer.heal.uneven.load.trigger': 'ANY_UNEVEN_LOAD'
      'ldap.com.sun.jndi.ldap.read.timeout': '60000'
      'ldap.refresh.interval.ms': '60000'
      'ldap.retry.timeout.ms': '6600000'
      'connections.max.reauth.ms': '3600000'
      'message.max.bytes' : '8388608'
      'confluent.consumer.lag.emitter.enabled': 'true'
      'confluent.consumer.lag.emitter.interval.ms': '60000'
     # 'delete.topic.enable': 'true'
      'confluent.tier.feature': 'true'
     # 'confluent.tier.enable': 'true'
      'confluent.tier.backend': 'S3'
      'confluent.tier.s3.bucket': 'streamingkafka-app-data'
      'confluent.tier.s3.prefix': 'application-data'
      'confluent.tier.s3.region': 'eu-north-1'
      'inter.broker.protocol.version': '3.5'
      'password.encoder.secret': 'secret'

    jvm:
      '-Djava.security.krb5.conf': '/etc/krb5.conf'
      '-Dcom.sun.jndi.ldap.debug': 'true' 
      '-Dcom.sun.management.jmxremote.authenticate': 'false'
      '-Dcom.sun.management.jmxremote.ssl': 'false'
      '-Dcom.sun.management.jmxremote.local.only': 'false'
      '-Dcom.sun.management.jmxremote.port': '7203'
      '-Dcom.sun.management.jmxremote.rmi.port': '7203' 
  listeners:
    internal:
      enabled: true
    external:
      enabled: true
      authentication:
        type: mtls
        principalMappingRules:
          # First rule may need to be altered to capture Scania-issued client certificates
          - RULE:CN[ ]?=[ ]?([a-zA-Z0-9-_]+),.*Scania.*/$1/
          - RULE:.*CN[ ]?=[ ]?([a-zA-Z0-9-_]+).*\.scania\.com.*/$1/  
      loadbalancer:
        internal: false
        name: iris-streaming-prod-mtlsaws
        sourceRanges: "13.48.14.192/32"
        brokerPrefix: mtlsaws
        bootstrapPrefix: mtlsaws 
      customServerConfiguration:
        'ssl.principal.mapping.rules': '${file:/mnt/secrets/mtls-mapping/mtls-mapping.txt:mapping}'
    custom:
      oauthaws:
        port: 9093
        authentication: 
          type: plain
          jaasConfig:
            secretRef: credential
        loadbalancer:
          enabled: true
          internal: false
          bootstrapPrefix: oauthaws
          name: iris-streaming-prod-oauthaws
          sourceRanges: "13.48.14.192/32"
        customServerConfiguration:
          'sasl.enabled.mechanisms': 'OAUTHBEARER'
          'sasl.mechanism': 'PLAIN'
          'sasl.oauthbearer.jwks.endpoint.url': 'https://fg.ciam.prod.aws.scania.com/auth/realms/scania/protocol/openid-connect/certs'
          'sasl.oauthbearer.expected.audience': 'account'
          'sasl.oauthbearer.sub.claim.name': 'clientId'
          'oauthbearer.sasl.server.callback.handler.class': 'org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler'
          'oauthbearer.sasl.jaas.config': 'org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required;'
      oauthonprem:
        port: 9095
        authentication:
          type: plain
          jaasConfig:
            secretRef: credential
        loadbalancer:
          enabled: true
          internal: true
          internalScheme: true
          name: iris-streaming-prod-oauthonprem
          sourceRanges: "13.48.14.192/32"
          bootstrapPrefix: oauthonprem
        customServerConfiguration:
          'sasl.enabled.mechanisms': 'OAUTHBEARER'
          'sasl.oauthbearer.jwks.endpoint.url': 'https://fg.ciam.prod.aws.scania.com/auth/realms/scania/protocol/openid-connect/certs'
          'sasl.oauthbearer.expected.audience': 'account'
          'sasl.oauthbearer.sub.claim.name': 'clientId'
          'oauthbearer.sasl.server.callback.handler.class': 'org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler'
          'oauthbearer.sasl.jaas.config': 'org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required;'
      oauthawseid:
        port: 9096
        authentication: 
          type: plain
          jaasConfig:
            secretRef: credential
        loadbalancer:
          enabled: true
          internal: false
          bootstrapPrefix: oauthawseid
          #name: iris-streaming-prod-oauthawseid
          sourceRanges: "13.48.14.192/32"
        customServerConfiguration:
          'sasl.enabled.mechanisms': 'OAUTHBEARER'
          'sasl.mechanism': 'PLAIN'
          'sasl.oauthbearer.jwks.endpoint.url': 'https://login.microsoftonline.com/common/discovery/keys'
          'sasl.oauthbearer.expected.audience': '638198fb-4b00-4570-ba1d-86cfbf73af32'
          'sasl.oauthbearer.sub.claim.name': 'sub'
          'oauthbearer.sasl.server.callback.handler.class': 'org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler'
          'oauthbearer.sasl.jaas.config': 'org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required;'
      oauthonpremeid:
        port: 9097
        authentication:
          type: plain
          jaasConfig:
            secretRef: credential
        loadbalancer:
          enabled: true
          internal: true
          #internalScheme: true
          #name: iris-streaming-prod-oauthonpremeid
          sourceRanges: "13.48.14.192/32"
          bootstrapPrefix: oauthonpremeid
        customServerConfiguration:
          'sasl.enabled.mechanisms': 'OAUTHBEARER'
          'sasl.oauthbearer.jwks.endpoint.url': 'https://login.microsoftonline.com/common/discovery/keys'
          'sasl.oauthbearer.expected.audience': '638198fb-4b00-4570-ba1d-86cfbf73af32'
          'sasl.oauthbearer.sub.claim.name': 'sub'
          'oauthbearer.sasl.server.callback.handler.class': 'org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler'
          'oauthbearer.sasl.jaas.config': 'org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required;'      
      mtlsonprem:
        port: 9094
        authentication:
          type: mtls
          principalMappingRules:
            # First rule may need to be altered to capture Scania-issued client certificates
            - RULE:CN[ ]?=[ ]?([a-zA-Z0-9-_]+),.*Scania.*/$1/
            - RULE:.*CN[ ]?=[ ]?([a-zA-Z0-9-_]+).*\.scania\.com.*/$1/
        loadbalancer:
          enabled: true
          internal: true
          name: iris-streaming-prod-mtlsonprem
          sourceRanges: "13.48.14.192/32"
          bootstrapPrefix: mtlsonprem
        customServerConfiguration:
          'ssl.principal.mapping.rules': '${file:/mnt/secrets/mtls-mapping/mtls-mapping.txt:mapping}'
  annotation:
    'ad.datadoghq.com/kafka.check_names': '["kafka"]'
    'ad.datadoghq.com/kafka.init_configs': '[{"is_jmx": true, "collect_default_metrics": false}]'
    'ad.datadoghq.com/kafka.instances': '[{"host": "%%host%%", "port": "7203", "max_returned_metrics": 25000, "conf": [{"include": {"domain": "kafka.server"}, "bean_regex": ["kafka.server:client-id=*,consumer-group=*,member=*,partition=*,topic=*,type=tenant-metrics"]}, {"include": {"domain": "kafka.producer"}, "bean_regex": ["kafka.producer:type=producer-metrics,client-id=*"]}]}]'
    'ad.datadoghq.com/kafka.logs': '[{"source":"kafka","service":"kafka"}]'
    'secret.reloader.stakater.com/reload': mtls-mapping
    'co.elastic.logs/enabled': "true"  