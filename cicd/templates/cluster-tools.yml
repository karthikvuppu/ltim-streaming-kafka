# deploy cluster tools
.cluster-tools-deploy:
  stage: cluster tools
  extends:
  - .helm-common
  - .authenticate
  script:
    - 'helm repo add bitnami https://charts.bitnami.com/bitnami'
    - 'helm repo add external-secrets https://charts.external-secrets.io'
    - "helm repo add elastic https://helm.elastic.co"
    - "helm repo add stakater https://stakater.github.io/stakater-charts"
    - "helm repo add datadog https://helm.datadoghq.com"
    - "helm repo add traefik https://traefik.github.io/charts"
    - 'helm upgrade 
      --install 
      external-dns 
      bitnami/external-dns 
      --namespace externaldns 
      --create-namespace 
      --values tooling/external-dns/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade
      --install  
      external-secrets external-secrets/external-secrets
      --namespace external-secrets 
      --create-namespace
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade 
      --install 
      filebeat elastic/filebeat 
      --namespace filebeat 
      --create-namespace 
      --values tooling/filebeat/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade 
      --install 
      stakater stakater/reloader 
      --namespace stakater-reloader 
      --create-namespace
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade
      --install
      datadog datadog/datadog
      --namespace datadog
      -f tooling/datadog/values.yaml
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade 
      --install cluster-tools charts/cluster-tools 
      --namespace confluent 
      -f tooling/cluster-tools/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
      --kube-context $EKS_CLUSTER'
    - |          
        if [[ $ENVIRONMENT == "sandbox" || $CLUSTER_TYPE == "external" ]];
          then
            'helm upgrade 
             --install
             traefik traefik/traefik
             --version 21.0.0
             --namespace ingress
             --create-namespace
             --values tooling/ingress/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml'
          fi
  when: manual
