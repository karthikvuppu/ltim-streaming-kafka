# deploy cluster tools
.cluster-tools-deploy:
  stage: cluster tools
  extends:
  - .helm-common
  - .authenticate

  script:
    - 'helm repo add bitnami https://charts.bitnami.com/bitnami'
    - 'helm repo add external-secrets https://charts.external-secrets.io'
    - "helm repo add elastic https://helm.elastic.co"
    - "helm repo add stakater https://stakater.github.io/stakater-charts"
    - "helm repo add datadog https://helm.datadoghq.com"
    - "helm repo add jetstack https://charts.jetstack.io"
    - "helm repo add traefik https://traefik.github.io/charts"
    - "helm repo add kafka-lag-exporter https://seglo.github.io/kafka-lag-exporter/repo/"
    - 'helm upgrade 
      --install 
      external-dns 
      bitnami/external-dns 
      --version 6.14.4
      --namespace externaldns 
      --create-namespace 
      --values tooling/external-dns/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade
      --install  
      external-secrets external-secrets/external-secrets
      --version v0.9.2
      --namespace external-secrets 
      --create-namespace
      --kube-context $EKS_CLUSTER'
#    - 'helm upgrade ##kafka-2469 filebeat removal 
#      --install 
#      filebeat elastic/filebeat 
#      --version 8.5.1
#      --namespace filebeat 
#      --create-namespace 
#      --values tooling/filebeat/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
#      --kube-context $EKS_CLUSTER'
    - 'helm upgrade 
      --install 
      stakater stakater/reloader 
      --version v1.0.15 
      --namespace stakater-reloader 
      --create-namespace
      --kube-context $EKS_CLUSTER'
    - 'helm upgrade
      --install
      --version 3.20.2 
      datadog datadog/datadog
      --namespace datadog
      -f tooling/datadog/values.yaml
      --kube-context $EKS_CLUSTER'
    #- 'helm upgrade 
    #  --install cluster-tools charts/cluster-tools 
    #  --namespace confluent 
    #  -f tooling/cluster-tools/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
    #  --kube-context $EKS_CLUSTER'
#    - 'helm upgrade 
#      --install  
#      --version 0.8.2 
#      kafka-lag-exporter kafka-lag-exporter/kafka-lag-exporter
#      --namespace kafka-lag-exporter 
#      --create-namespace 
#      -f tooling/kafka-lag-exporter/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml
#      --kube-context $EKS_CLUSTER'

    ################## Script to create kubernetes secrets and configmap for clusterlink dashboard setup on datadog ##################
    - chmod +x cicd/scripts/.clusterlink-datadog-dashboard.sh
    - . cicd/scripts/.clusterlink-datadog-dashboard.sh
    ################## End of block ##################

    - 'helm upgrade 
     --install clusterlink-dashboard charts/clusterlink-dashboard
     --namespace confluent 
     -f tooling/clusterlink-dashboard/production/values.yaml
     --kube-context $EKS_CLUSTER'


    - |
        if [[ ( $ENVIRONMENT == "sandbox" || $ENVIRONMENT == "devtest" ) && $CLUSTER_TYPE == "external" ]];
        then
          helm upgrade \
          --install \
          cert-manager jetstack/cert-manager \
          --version v1.11.0 \
          --namespace cert-manager \
          --create-namespace \
          --values tooling/cert-manager/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml \
          --kube-context $EKS_CLUSTER
        fi
    - |
        if [[ ( $ENVIRONMENT == "sandbox" || $ENVIRONMENT == "devtest" ) && $CLUSTER_TYPE == "external" ]];
        then
          helm upgrade \
          --install \
          traefik traefik/traefik \
          --version 21.0.0 \
          --namespace ingress \
          --create-namespace \
          --values tooling/ingress/$ENVIRONMENT/values-$CLUSTER_TYPE.yaml \
          --kube-context $EKS_CLUSTER
        fi
  when: manual
